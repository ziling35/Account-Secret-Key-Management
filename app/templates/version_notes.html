{% extends "base.html" %}

{% block title %}版本说明管理 - Windsurf账号池管理系统{% endblock %}

{% block content %}
<div id="app">
    <div class="page-header">
        <h1><i class="bi bi-journal-text"></i> 版本说明管理</h1>
        <el-button type="primary" @click="showCreateDialog" icon="Plus">
            添加版本说明
        </el-button>
    </div>

    <!-- 版本说明列表 -->
    <el-card class="box-card" v-loading="loading">
        <div v-if="notes.length === 0" class="empty-state">
            <i class="bi bi-inbox" style="font-size: 48px; color: #ccc;"></i>
            <p>暂无版本说明</p>
        </div>
        
        <div v-else>
            <el-table :data="notes" style="width: 100%">
                <el-table-column prop="version" label="版本号" width="120"></el-table-column>
                
                <el-table-column prop="title" label="标题" min-width="200"></el-table-column>
                
                <el-table-column label="内容预览" min-width="300">
                    <template #default="scope">
                        <div class="content-preview">
                            [[ scope.row.content.substring(0, 80) ]]
                            <span v-if="scope.row.content.length > 80">...</span>
                        </div>
                    </template>
                </el-table-column>
                
                <el-table-column label="发布日期" width="120">
                    <template #default="scope">
                        [[ formatDate(scope.row.release_date) ]]
                    </template>
                </el-table-column>
                
                <el-table-column label="状态" width="100">
                    <template #default="scope">
                        <el-tag :type="scope.row.is_published ? 'success' : 'info'">
                            [[ scope.row.is_published ? '已发布' : '草稿' ]]
                        </el-tag>
                    </template>
                </el-table-column>
                
                <el-table-column label="操作" width="220" fixed="right">
                    <template #default="scope">
                        <el-button 
                            size="small" 
                            @click="toggleStatus(scope.row)"
                            :type="scope.row.is_published ? 'warning' : 'success'">
                            [[ scope.row.is_published ? '取消发布' : '发布' ]]
                        </el-button>
                        <el-button 
                            size="small" 
                            type="primary"
                            @click="showEditDialog(scope.row)">
                            编辑
                        </el-button>
                        <el-button 
                            size="small" 
                            type="danger"
                            @click="deleteNote(scope.row)">
                            删除
                        </el-button>
                    </template>
                </el-table-column>
            </el-table>
        </div>
    </el-card>

    <!-- 创建/编辑对话框 -->
    <el-dialog 
        :title="dialogMode === 'create' ? '添加版本说明' : '编辑版本说明'"
        v-model="dialogVisible"
        width="700px">
        <el-form :model="form" label-width="100px">
            <el-form-item label="版本号" required>
                <el-input 
                    v-model="form.version"
                    placeholder="如：1.0.0">
                </el-input>
            </el-form-item>
            
            <el-form-item label="标题" required>
                <el-input 
                    v-model="form.title"
                    placeholder="版本标题">
                </el-input>
            </el-form-item>
            
            <el-form-item label="发布日期">
                <el-date-picker
                    v-model="form.release_date"
                    type="date"
                    placeholder="选择日期"
                    format="YYYY-MM-DD"
                    value-format="YYYY-MM-DD">
                </el-date-picker>
            </el-form-item>
            
            <el-form-item label="版本说明" required>
                <el-input 
                    v-model="form.content"
                    type="textarea"
                    :rows="12"
                    placeholder="请输入版本说明内容，支持 Markdown 格式"
                    maxlength="5000"
                    show-word-limit>
                </el-input>
            </el-form-item>
            
            <el-form-item label="发布状态">
                <el-switch 
                    v-model="form.is_published"
                    active-text="发布"
                    inactive-text="草稿">
                </el-switch>
            </el-form-item>
        </el-form>
        
        <template #footer>
            <el-button @click="dialogVisible = false">取消</el-button>
            <el-button type="primary" @click="submitForm" :loading="submitting">
                [[ dialogMode === 'create' ? '创建' : '保存' ]]
            </el-button>
        </template>
    </el-dialog>
</div>
{% endblock %}

{% block scripts %}
<script>
const { createApp, ref, onMounted } = Vue;

const app = createApp({
    delimiters: ['[[', ']]'],
    setup() {
        const loading = ref(false);
        const submitting = ref(false);
        const notes = ref([]);
        const dialogVisible = ref(false);
        const dialogMode = ref('create');
        const editingId = ref(null);
        
        const form = ref({
            version: '',
            title: '',
            content: '',
            release_date: null,
            is_published: true
        });
        
        // 加载版本说明列表
        const loadNotes = async () => {
            loading.value = true;
            try {
                const response = await fetch('/admin/api/version-notes');
                const data = await response.json();
                if (data.success) {
                    notes.value = data.data;
                }
            } catch (error) {
                ElementPlus.ElMessage.error('加载版本说明失败');
            } finally {
                loading.value = false;
            }
        };
        
        // 格式化日期
        const formatDate = (dateStr) => {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('zh-CN');
        };
        
        // 显示创建对话框
        const showCreateDialog = () => {
            dialogMode.value = 'create';
            editingId.value = null;
            form.value = {
                version: '',
                title: '',
                content: '',
                release_date: null,
                is_published: true
            };
            dialogVisible.value = true;
        };
        
        // 显示编辑对话框
        const showEditDialog = (note) => {
            dialogMode.value = 'edit';
            editingId.value = note.id;
            form.value = {
                version: note.version,
                title: note.title,
                content: note.content,
                release_date: note.release_date ? note.release_date.split('T')[0] : null,
                is_published: note.is_published
            };
            dialogVisible.value = true;
        };
        
        // 提交表单
        const submitForm = async () => {
            if (!form.value.version || !form.value.title || !form.value.content) {
                ElementPlus.ElMessage.warning('请填写必填项');
                return;
            }
            
            submitting.value = true;
            try {
                const formData = new FormData();
                formData.append('version', form.value.version);
                formData.append('title', form.value.title);
                formData.append('content', form.value.content);
                if (form.value.release_date) {
                    formData.append('release_date', form.value.release_date);
                }
                formData.append('is_published', form.value.is_published);
                
                const url = dialogMode.value === 'create' 
                    ? '/admin/api/version-notes'
                    : `/admin/api/version-notes/${editingId.value}`;
                const method = dialogMode.value === 'create' ? 'POST' : 'PUT';
                
                const response = await fetch(url, {
                    method: method,
                    body: formData
                });
                
                const data = await response.json();
                if (data.success) {
                    ElementPlus.ElMessage.success(data.message);
                    dialogVisible.value = false;
                    loadNotes();
                } else {
                    ElementPlus.ElMessage.error(data.detail || '操作失败');
                }
            } catch (error) {
                ElementPlus.ElMessage.error('操作失败');
            } finally {
                submitting.value = false;
            }
        };
        
        // 切换发布状态
        const toggleStatus = async (note) => {
            try {
                const response = await fetch(`/admin/api/version-notes/${note.id}/toggle`, {
                    method: 'POST'
                });
                const data = await response.json();
                if (data.success) {
                    ElementPlus.ElMessage.success(data.message);
                    loadNotes();
                } else {
                    ElementPlus.ElMessage.error(data.detail || '操作失败');
                }
            } catch (error) {
                ElementPlus.ElMessage.error('操作失败');
            }
        };
        
        // 删除版本说明
        const deleteNote = async (note) => {
            try {
                await ElementPlus.ElMessageBox.confirm(
                    `确定要删除版本 ${note.version} 的说明吗？`,
                    '确认删除',
                    { type: 'warning' }
                );
                
                const response = await fetch(`/admin/api/version-notes/${note.id}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (data.success) {
                    ElementPlus.ElMessage.success(data.message);
                    loadNotes();
                } else {
                    ElementPlus.ElMessage.error(data.detail || '删除失败');
                }
            } catch (error) {
                if (error !== 'cancel') {
                    ElementPlus.ElMessage.error('删除失败');
                }
            }
        };
        
        onMounted(() => {
            loadNotes();
        });
        
        return {
            loading,
            submitting,
            notes,
            dialogVisible,
            dialogMode,
            form,
            formatDate,
            showCreateDialog,
            showEditDialog,
            submitForm,
            toggleStatus,
            deleteNote
        };
    }
});

app.use(ElementPlus);
app.mount('#app');
</script>

<style>
.content-preview {
    color: #666;
    font-size: 13px;
    line-height: 1.5;
}
.empty-state {
    text-align: center;
    padding: 60px 0;
    color: #999;
}
</style>
{% endblock %}
