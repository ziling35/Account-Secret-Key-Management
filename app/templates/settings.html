{% extends "base.html" %}

{% block title %}系统设置 - Windsurf账号池管理系统{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title"><i class="bi bi-gear"></i> 系统设置</h1>
</div>

{% raw %}
<div id="settingsApp" v-cloak>
    <!-- 版本控制设置 -->
    <el-card class="box-card" style="margin-bottom: 20px;">
        <template #header>
            <div class="card-header">
                <span><i class="bi bi-code-square"></i> 版本控制设置</span>
                <el-button type="primary" @click="handleSave" :loading="saving" :icon="Check">保存设置</el-button>
            </div>
        </template>

        <el-form :model="versionForm" label-width="160px" style="max-width: 800px;">
            <el-form-item label="服务器版本号">
                <el-input 
                    v-model="versionForm.server_version" 
                    placeholder="例如: 1.0.0"
                    style="width: 300px;">
                    <template #prepend>
                        <i class="bi bi-server"></i>
                    </template>
                </el-input>
                <div style="color: #909399; font-size: 13px; margin-top: 6px;">
                    <i class="bi bi-info-circle"></i> 当前后端服务器的版本号
                </div>
            </el-form-item>

            <el-form-item label="最低客户端版本">
                <el-input 
                    v-model="versionForm.min_client_version" 
                    placeholder="例如: 1.0.0"
                    style="width: 300px;">
                    <template #prepend>
                        <i class="bi bi-pc-display"></i>
                    </template>
                </el-input>
                <div style="color: #909399; font-size: 13px; margin-top: 6px;">
                    <i class="bi bi-info-circle"></i> 低于此版本的客户端将被强制要求更新
                </div>
            </el-form-item>

            <el-form-item label="更新提示消息">
                <el-input 
                    v-model="versionForm.update_message" 
                    type="textarea"
                    :rows="3"
                    placeholder="例如: 发现新版本，请立即更新客户端以使用最新功能"
                    style="width: 500px;">
                </el-input>
                <div style="color: #909399; font-size: 13px; margin-top: 6px;">
                    <i class="bi bi-info-circle"></i> 客户端版本过低时显示的提示信息
                </div>
            </el-form-item>

            <el-divider></el-divider>

            <el-alert
                title="版本号格式说明"
                type="info"
                :closable="false"
                style="margin-bottom: 20px;">
                <template #default>
                    <div style="line-height: 1.8;">
                        <p style="margin: 0 0 8px 0;"><strong>格式：</strong>主版本.次版本.修订号 (例如: 1.2.3)</p>
                        <p style="margin: 0 0 4px 0;"><strong>示例：</strong></p>
                        <ul style="margin: 4px 0 0 20px; padding: 0;">
                            <li>1.0.0 - 初始版本</li>
                            <li>1.0.1 - 小修复</li>
                            <li>1.1.0 - 新增功能</li>
                            <li>2.0.0 - 重大更新</li>
                        </ul>
                    </div>
                </template>
            </el-alert>

            <el-alert
                title="使用说明"
                type="warning"
                :closable="false">
                <template #default>
                    <div style="line-height: 1.8;">
                        <p style="margin: 0 0 8px 0;"><strong>⚠️ 重要提示：</strong></p>
                        <ul style="margin: 4px 0 0 20px; padding: 0;">
                            <li><strong>强制更新机制：</strong>当客户端版本 < 最低客户端版本时，用户将无法使用任何功能</li>
                            <li><strong>谨慎修改：</strong>修改"最低客户端版本"将影响所有用户，建议提前通知</li>
                            <li><strong>回滚方法：</strong>如需取消强制更新，将"最低客户端版本"改回较低版本即可</li>
                        </ul>
                    </div>
                </template>
            </el-alert>
        </el-form>
    </el-card>

    <!-- Firebase API Key 配置 -->
    <el-card class="box-card" style="margin-bottom: 20px;">
        <template #header>
            <div class="card-header">
                <span><i class="bi bi-key-fill"></i> Firebase API Key 配置</span>
                <div>
                    <el-button @click="handleTestFirebase" :loading="testing" :icon="Connection">测试连接</el-button>
                    <el-button type="primary" @click="handleSaveFirebase" :loading="savingFirebase" :icon="Check">保存设置</el-button>
                </div>
            </div>
        </template>

        <el-form :model="firebaseForm" label-width="160px" style="max-width: 800px;">
            <el-form-item label="Firebase API Key">
                <el-input 
                    v-model="firebaseForm.firebase_api_key" 
                    placeholder="AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
                    style="width: 500px;"
                    show-password>
                    <template #prepend>
                        <i class="bi bi-shield-lock"></i>
                    </template>
                </el-input>
                <div style="color: #909399; font-size: 13px; margin-top: 6px;">
                    <i class="bi bi-info-circle"></i> 用于账号密码登录功能，获取 Windsurf API Key
                </div>
            </el-form-item>

            <el-alert
                v-if="firebaseForm.using_env"
                title="环境变量配置优先"
                type="warning"
                :closable="false"
                style="margin-bottom: 20px;">
                <template #default>
                    <div style="line-height: 1.8;">
                        <p style="margin: 0 0 8px 0;"><strong>⚠️ 检测到环境变量配置：</strong></p>
                        <p style="margin: 0; font-family: monospace; background: #f5f5f5; padding: 8px; border-radius: 4px;">
                            FIREBASE_API_KEY={{ firebaseForm.env_firebase_api_key }}
                        </p>
                        <p style="margin: 8px 0 0 0; color: #E6A23C;">
                            系统将优先使用环境变量中的配置，数据库配置将被忽略。
                        </p>
                    </div>
                </template>
            </el-alert>

            <el-divider></el-divider>

            <el-alert
                title="如何获取 Firebase API Key"
                type="info"
                :closable="false"
                style="margin-bottom: 20px;">
                <template #default>
                    <div style="line-height: 1.8;">
                        <p style="margin: 0 0 8px 0;"><strong>方法 1：浏览器开发者工具（推荐）</strong></p>
                        <ol style="margin: 4px 0 12px 20px; padding: 0;">
                            <li>访问 <a href="https://windsurf.com" target="_blank">https://windsurf.com</a></li>
                            <li>按 F12 打开开发者工具</li>
                            <li>切换到 Network（网络）标签</li>
                            <li>刷新页面（F5）</li>
                            <li>搜索 "firebase" 或 "identitytoolkit"</li>
                            <li>在请求 URL 中找到 key= 参数</li>
                        </ol>
                        <p style="margin: 0 0 4px 0;"><strong>格式：</strong>以 AIza 开头，共 39 个字符</p>
                        <p style="margin: 0; font-family: monospace; background: #f5f5f5; padding: 8px; border-radius: 4px;">
                            AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                        </p>
                    </div>
                </template>
            </el-alert>

            <el-alert
                title="测试说明"
                type="success"
                :closable="false">
                <template #default>
                    <div style="line-height: 1.8;">
                        <p style="margin: 0 0 8px 0;"><strong>✅ 测试连接功能：</strong></p>
                        <ul style="margin: 4px 0 0 20px; padding: 0;">
                            <li>点击"测试连接"按钮验证 API Key 是否有效</li>
                            <li>测试会向 Firebase 发送一个测试请求</li>
                            <li>如果返回正常错误（如邮箱不存在），说明 Key 有效</li>
                            <li>如果返回 API Key 无效错误，需要重新获取</li>
                        </ul>
                    </div>
                </template>
            </el-alert>
        </el-form>
    </el-card>

    <!-- 固定Pro账号配置 -->
    <el-card class="box-card" style="margin-bottom: 20px;">
        <template #header>
            <div class="card-header">
                <span><i class="bi bi-star-fill" style="color: #f59e0b;"></i> 固定Pro账号配置</span>
                <el-button type="primary" @click="handleSaveFixedPro" :loading="savingFixedPro" :icon="Check">保存配置</el-button>
            </div>
        </template>

        <el-form :model="fixedProForm" label-width="160px" style="max-width: 800px;">
            <el-form-item label="固定邮箱">
                <el-input 
                    v-model="fixedProForm.fixed_pro_email" 
                    placeholder="pro_user@windsurf.com"
                    style="width: 400px;">
                    <template #prepend>
                        <i class="bi bi-envelope"></i>
                    </template>
                </el-input>
                <div style="color: #909399; font-size: 13px; margin-top: 6px;">
                    <i class="bi bi-info-circle"></i> Pro卡密返回的固定邮箱地址（一键切号需要）
                </div>
            </el-form-item>

            <el-form-item label="固定密码">
                <el-input 
                    v-model="fixedProForm.fixed_pro_password" 
                    placeholder="请输入Pro账号密码"
                    style="width: 400px;"
                    type="password"
                    show-password>
                    <template #prepend>
                        <i class="bi bi-lock"></i>
                    </template>
                </el-input>
                <div style="color: #909399; font-size: 13px; margin-top: 6px;">
                    <i class="bi bi-info-circle"></i> Pro账号密码（一键切号无感换号需要，留空则保持原值）
                </div>
                <el-tag v-if="fixedProForm.has_password" type="success" size="small" style="margin-top: 4px;">
                    <i class="bi bi-check-circle"></i> 已配置密码
                </el-tag>
                <el-tag v-else type="warning" size="small" style="margin-top: 4px;">
                    <i class="bi bi-exclamation-triangle"></i> 未配置密码（一键切号将无法使用）
                </el-tag>
            </el-form-item>

            <el-form-item label="固定名称">
                <el-input 
                    v-model="fixedProForm.fixed_pro_name" 
                    placeholder="ProUser"
                    style="width: 400px;">
                    <template #prepend>
                        <i class="bi bi-person"></i>
                    </template>
                </el-input>
                <div style="color: #909399; font-size: 13px; margin-top: 6px;">
                    <i class="bi bi-info-circle"></i> Pro卡密返回的固定用户名
                </div>
            </el-form-item>

            <el-form-item label="API Key">
                <el-input 
                    v-model="fixedProForm.fixed_pro_api_key" 
                    placeholder="sk-ws-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
                    style="width: 500px;"
                    type="textarea"
                    :rows="3">
                </el-input>
                <div style="color: #909399; font-size: 13px; margin-top: 6px;">
                    <i class="bi bi-info-circle"></i> Pro账号的 API Key（需要手动更新）
                </div>
            </el-form-item>

            <el-divider></el-divider>

            <el-alert
                title="Pro账号配置说明"
                type="warning"
                :closable="false"
                style="margin-bottom: 20px;">
                <template #default>
                    <div style="line-height: 1.8;">
                        <p style="margin: 0 0 8px 0;"><strong>⚠️ 重要提示：</strong></p>
                        <ul style="margin: 4px 0 0 20px; padding: 0;">
                            <li><strong>固定账号：</strong>所有Pro卡密用户将获取到相同的账号信息</li>
                            <li><strong>密码：</strong>用于一键切号无感换号功能，需要真实的Pro账号密码</li>
                            <li><strong>API Key：</strong>用于普通获取账号功能，需要手动更新</li>
                            <li><strong>邮箱和名称：</strong>仅用于展示，可自定义</li>
                        </ul>
                    </div>
                </template>
            </el-alert>

            <el-descriptions :column="1" border size="small">
                <el-descriptions-item label="当前状态">
                    <el-tag v-if="fixedProForm.fixed_pro_api_key" type="success">
                        <i class="bi bi-check-circle"></i> 已配置
                    </el-tag>
                    <el-tag v-else type="danger">
                        <i class="bi bi-x-circle"></i> 未配置 API Key
                    </el-tag>
                </el-descriptions-item>
            </el-descriptions>
        </el-form>
    </el-card>

    <!-- 配置预览 -->
    <el-card class="box-card">
        <template #header>
            <div class="card-header">
                <span><i class="bi bi-eye"></i> 当前配置预览</span>
                <el-button @click="handleRefresh" :icon="Refresh">刷新</el-button>
            </div>
        </template>

        <el-descriptions :column="2" border>
            <el-descriptions-item label="服务器版本号">
                <el-tag type="success" size="large">{{ versionForm.server_version || '-' }}</el-tag>
            </el-descriptions-item>
            <el-descriptions-item label="最低客户端版本">
                <el-tag type="warning" size="large">{{ versionForm.min_client_version || '-' }}</el-tag>
            </el-descriptions-item>
            <el-descriptions-item label="更新提示消息" :span="2">
                {{ versionForm.update_message || '-' }}
            </el-descriptions-item>
            <el-descriptions-item label="版本比较结果" :span="2">
                <div v-if="compareVersions()">
                    <el-tag v-if="compareVersions() === 'valid'" type="success">
                        <i class="bi bi-check-circle"></i> 配置正常
                    </el-tag>
                    <el-tag v-else-if="compareVersions() === 'warning'" type="warning">
                        <i class="bi bi-exclamation-triangle"></i> 最低版本高于服务器版本，建议调整
                    </el-tag>
                    <el-tag v-else type="info">
                        <i class="bi bi-info-circle"></i> 版本相同
                    </el-tag>
                </div>
            </el-descriptions-item>
        </el-descriptions>
    </el-card>
</div>
{% endraw %}
{% endblock %}

{% block scripts %}
<script>
const { createApp, ref, onMounted } = Vue;
const { ElMessage, ElMessageBox } = ElementPlus;

createApp({
    setup() {
        // 图标
        const Check = ElementPlusIconsVue.Check;
        const Refresh = ElementPlusIconsVue.Refresh;
        const Connection = ElementPlusIconsVue.Connection;

        // 数据
        const loading = ref(false);
        const saving = ref(false);
        const savingFirebase = ref(false);
        const testing = ref(false);
        const versionForm = ref({
            server_version: '',
            min_client_version: '',
            update_message: ''
        });
        const firebaseForm = ref({
            firebase_api_key: '',
            env_firebase_api_key: '',
            using_env: false
        });
        const fixedProForm = ref({
            fixed_pro_email: '',
            fixed_pro_password: '',
            fixed_pro_name: '',
            fixed_pro_api_key: '',
            has_password: false
        });
        const savingFixedPro = ref(false);

        // 加载配置
        const loadConfig = async () => {
            loading.value = true;
            try {
                const response = await axios.get('/admin/api/settings/version');
                versionForm.value = response.data;
                
                // 加载 Firebase 配置
                const firebaseResponse = await axios.get('/admin/api/settings/firebase');
                firebaseForm.value = firebaseResponse.data;
                
                // 加载固定Pro账号配置
                const fixedProResponse = await axios.get('/admin/api/settings/fixed-pro');
                fixedProForm.value = fixedProResponse.data;
                
                ElMessage.success('配置加载成功');
            } catch (error) {
                ElMessage.error('加载失败: ' + (error.response?.data?.detail || error.message));
            } finally {
                loading.value = false;
            }
        };

        // 保存配置
        const handleSave = async () => {
            // 验证版本号格式
            const versionRegex = /^\d+\.\d+\.\d+$/;
            if (!versionRegex.test(versionForm.value.server_version)) {
                ElMessage.error('服务器版本号格式不正确，应为 x.y.z 格式（例如: 1.0.0）');
                return;
            }
            if (!versionRegex.test(versionForm.value.min_client_version)) {
                ElMessage.error('最低客户端版本格式不正确，应为 x.y.z 格式（例如: 1.0.0）');
                return;
            }

            // 比较版本并警告
            const comparison = compareVersions();
            if (comparison === 'warning') {
                try {
                    await ElMessageBox.confirm(
                        '最低客户端版本高于服务器版本，这可能导致混乱。确定要保存吗？',
                        '版本配置警告',
                        {
                            confirmButtonText: '确定保存',
                            cancelButtonText: '取消',
                            type: 'warning'
                        }
                    );
                } catch {
                    return;
                }
            }

            saving.value = true;
            try {
                const response = await axios.post('/admin/api/settings/version', versionForm.value);
                ElMessage.success('保存成功！');
            } catch (error) {
                ElMessage.error('保存失败: ' + (error.response?.data?.detail || error.message));
            } finally {
                saving.value = false;
            }
        };

        // 刷新配置
        const handleRefresh = () => {
            loadConfig();
        };

        // 比较版本号
        const compareVersions = () => {
            const parseVersion = (v) => {
                if (!v) return [0, 0, 0];
                return v.split('.').map(n => parseInt(n) || 0);
            };

            const server = parseVersion(versionForm.value.server_version);
            const minClient = parseVersion(versionForm.value.min_client_version);

            // 比较版本
            for (let i = 0; i < 3; i++) {
                if (minClient[i] > server[i]) return 'warning';
                if (minClient[i] < server[i]) return 'valid';
            }
            return 'equal';
        };

        // 保存 Firebase 配置
        const handleSaveFirebase = async () => {
            if (!firebaseForm.value.firebase_api_key) {
                ElMessage.error('Firebase API Key 不能为空');
                return;
            }

            // 验证格式
            if (!firebaseForm.value.firebase_api_key.startsWith('AIza') || 
                firebaseForm.value.firebase_api_key.length !== 39) {
                ElMessage.error('Firebase API Key 格式不正确（应以 AIza 开头，共39个字符）');
                return;
            }

            savingFirebase.value = true;
            try {
                const formData = new FormData();
                formData.append('firebase_api_key', firebaseForm.value.firebase_api_key);
                
                const response = await axios.post('/admin/api/settings/firebase', formData);
                ElMessage.success(response.data.message);
                
                if (response.data.warning) {
                    ElMessage.warning(response.data.warning);
                }
                
                // 重新加载配置
                await loadConfig();
            } catch (error) {
                ElMessage.error('保存失败: ' + (error.response?.data?.detail || error.message));
            } finally {
                savingFirebase.value = false;
            }
        };

        // 保存固定Pro账号配置
        const handleSaveFixedPro = async () => {
            if (!fixedProForm.value.fixed_pro_api_key) {
                ElMessage.warning('请填写 API Key');
                return;
            }

            savingFixedPro.value = true;
            try {
                const formData = new FormData();
                formData.append('fixed_pro_email', fixedProForm.value.fixed_pro_email);
                formData.append('fixed_pro_password', fixedProForm.value.fixed_pro_password || '');
                formData.append('fixed_pro_name', fixedProForm.value.fixed_pro_name);
                formData.append('fixed_pro_api_key', fixedProForm.value.fixed_pro_api_key);
                
                const response = await axios.post('/admin/api/settings/fixed-pro', formData);
                ElMessage.success(response.data.message);
            } catch (error) {
                ElMessage.error('保存失败: ' + (error.response?.data?.detail || error.message));
            } finally {
                savingFixedPro.value = false;
            }
        };

        // 测试 Firebase API Key
        const handleTestFirebase = async () => {
            if (!firebaseForm.value.firebase_api_key) {
                ElMessage.error('请先输入 Firebase API Key');
                return;
            }

            testing.value = true;
            try {
                const formData = new FormData();
                formData.append('firebase_api_key', firebaseForm.value.firebase_api_key);
                
                const response = await axios.post('/admin/api/settings/firebase/test', formData);
                
                if (response.data.valid) {
                    ElMessage.success(response.data.message);
                } else {
                    ElMessage.error(response.data.message);
                }
            } catch (error) {
                ElMessage.error('测试失败: ' + (error.response?.data?.detail || error.message));
            } finally {
                testing.value = false;
            }
        };

        onMounted(() => {
            loadConfig();
        });

        return {
            Check, Refresh, Connection,
            loading, saving, savingFirebase, testing, savingFixedPro,
            versionForm, firebaseForm, fixedProForm,
            loadConfig, handleSave, handleRefresh, compareVersions,
            handleSaveFirebase, handleTestFirebase, handleSaveFixedPro
        };
    }
}).use(ElementPlus).mount('#settingsApp');
</script>
{% endblock %}
