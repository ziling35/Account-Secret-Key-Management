# 版本控制管理界面说明

## 功能概述

为管理后台添加了"系统设置"页面，管理员可以通过可视化界面直接修改版本控制配置，无需手动操作数据库。

---

## 实现内容

### 1. 侧边栏导航 (`app/templates/base.html`)

新增"系统设置"菜单项：

```html
<li>
    <a href="/admin/settings" class="{% if '/settings' in request.url.path %}active{% endif %}">
        <i class="bi bi-gear"></i>
        <span>系统设置</span>
    </a>
</li>
```

**位置**: 在"账号管理"下方

---

### 2. 系统设置页面 (`app/templates/settings.html`)

#### 页面结构

```
┌─────────────────────────────────────────┐
│          系统设置                        │
├─────────────────────────────────────────┤
│ 📦 版本控制设置           [保存设置]    │
│                                          │
│  服务器版本号:    [1.0.0    ]           │
│  最低客户端版本:  [1.0.0    ]           │
│  更新提示消息:                           │
│  ┌────────────────────────┐             │
│  │发现新版本，请立即更新...│             │
│  └────────────────────────┘             │
│                                          │
│  ℹ️ 版本号格式说明                       │
│  ⚠️ 使用说明                            │
├─────────────────────────────────────────┤
│ 👁️ 当前配置预览            [刷新]       │
│                                          │
│  服务器版本号:      [1.0.0]             │
│  最低客户端版本:    [1.0.0]             │
│  更新提示消息:      发现新版本...        │
│  版本比较结果:      ✓ 配置正常          │
└─────────────────────────────────────────┘
```

#### 功能特性

**1. 版本控制设置卡片**
- ✅ 服务器版本号输入框
- ✅ 最低客户端版本输入框
- ✅ 更新提示消息文本域
- ✅ 实时版本格式验证
- ✅ 保存按钮（带 loading 状态）

**2. 配置预览卡片**
- ✅ 显示当前生效的配置
- ✅ 版本号标签（彩色）
- ✅ 版本比较结果显示
- ✅ 刷新按钮

**3. 帮助信息**
- ✅ 版本号格式说明（info）
- ✅ 使用说明和重要提示（warning）

---

### 3. 后端 API (`app/routers/admin.py`)

#### 路由注册

```python
@router.get("/settings", response_class=HTMLResponse)
async def settings_page(request: Request, username: str = Depends(verify_admin)):
    """系统设置页面"""
    return templates.TemplateResponse("settings.html", {"request": request})
```

#### API 端点

**1. 获取版本配置**

```python
GET /admin/api/settings/version
```

**权限**: 需要管理员登录

**返回**:
```json
{
  "server_version": "1.0.0",
  "min_client_version": "1.0.0",
  "update_message": "发现新版本，请立即更新客户端"
}
```

**2. 更新版本配置**

```python
POST /admin/api/settings/version
Content-Type: application/json
```

**请求体**:
```json
{
  "server_version": "1.1.0",
  "min_client_version": "1.1.0",
  "update_message": "新版本发布，请立即更新"
}
```

**返回**:
```json
{
  "success": true,
  "message": "版本配置已更新"
}
```

**验证规则**:
- 版本号格式必须为 `x.y.z`（例如: `1.0.0`）
- 不符合格式返回 400 错误

---

### 4. 前端交互逻辑

#### Vue 3 + Element Plus 实现

**数据模型**:
```javascript
const versionForm = ref({
    server_version: '',
    min_client_version: '',
    update_message: ''
});
```

**核心功能**:

1. **加载配置**
```javascript
const loadConfig = async () => {
    const response = await axios.get('/admin/api/settings/version');
    versionForm.value = response.data;
};
```

2. **保存配置**
```javascript
const handleSave = async () => {
    // 1. 验证版本号格式
    const versionRegex = /^\d+\.\d+\.\d+$/;
    
    // 2. 版本比较警告
    if (min_client_version > server_version) {
        await ElMessageBox.confirm('版本配置警告...');
    }
    
    // 3. 发送保存请求
    await axios.post('/admin/api/settings/version', versionForm.value);
};
```

3. **版本比较**
```javascript
const compareVersions = () => {
    // 解析版本号并比较
    // 返回: 'valid', 'warning', 'equal'
};
```

---

## 使用流程

### 场景 1: 发布新版本并强制更新

**步骤**:

1. **登录管理后台**
   - 访问 `/admin/login`
   - 使用管理员账号登录

2. **进入系统设置**
   - 点击左侧菜单"系统设置"
   - 或访问 `/admin/settings`

3. **修改版本配置**
   ```
   服务器版本号:     1.1.0  (从 1.0.0 升级)
   最低客户端版本:   1.1.0  (强制要求客户端升级)
   更新提示消息:     新版本 v1.1.0 已发布，请立即更新以使用新功能
   ```

4. **保存配置**
   - 点击"保存设置"按钮
   - 等待成功提示

5. **效果**
   - 所有 `< 1.1.0` 版本的客户端将无法使用
   - 客户端显示强制更新弹窗

---

### 场景 2: 取消强制更新

如果误操作或需要回滚：

**步骤**:

1. 进入系统设置页面
2. 修改配置：
   ```
   最低客户端版本:   1.0.0  (降低要求)
   ```
3. 保存配置
4. 所有客户端立即可以正常使用

---

### 场景 3: 仅更新服务器版本（不强制客户端更新）

**步骤**:

1. 进入系统设置页面
2. 修改配置：
   ```
   服务器版本号:     1.1.0  (新版本)
   最低客户端版本:   1.0.0  (保持不变)
   ```
3. 保存配置
4. 客户端可以继续使用，但会看到有新版本提示

---

## 界面截图说明

### 版本控制设置区域

```
╔═══════════════════════════════════════════╗
║ 📦 版本控制设置              [保存设置]   ║
╠═══════════════════════════════════════════╣
║                                            ║
║  服务器版本号                              ║
║  ┌────────┬──────────────────┐            ║
║  │ 🖥️ server │ 1.0.0            │            ║
║  └────────┴──────────────────┘            ║
║  ℹ️ 当前后端服务器的版本号                  ║
║                                            ║
║  最低客户端版本                            ║
║  ┌────────┬──────────────────┐            ║
║  │ 💻 client │ 1.0.0            │            ║
║  └────────┴──────────────────┘            ║
║  ℹ️ 低于此版本的客户端将被强制要求更新      ║
║                                            ║
║  更新提示消息                              ║
║  ┌────────────────────────────────┐      ║
║  │ 发现新版本，请立即更新客户端以    │      ║
║  │ 使用最新功能                      │      ║
║  └────────────────────────────────┘      ║
║  ℹ️ 客户端版本过低时显示的提示信息        ║
║                                            ║
╚═══════════════════════════════════════════╝
```

### 版本号格式说明

```
╔═══════════════════════════════════════════╗
║ ℹ️ 版本号格式说明                          ║
╠═══════════════════════════════════════════╣
║ 格式：主版本.次版本.修订号 (例如: 1.2.3)  ║
║                                            ║
║ 示例：                                     ║
║  • 1.0.0 - 初始版本                       ║
║  • 1.0.1 - 小修复                         ║
║  • 1.1.0 - 新增功能                       ║
║  • 2.0.0 - 重大更新                       ║
╚═══════════════════════════════════════════╝
```

### 使用说明

```
╔═══════════════════════════════════════════╗
║ ⚠️ 使用说明                                ║
╠═══════════════════════════════════════════╣
║ ⚠️ 重要提示：                              ║
║                                            ║
║  • 强制更新机制：当客户端版本 < 最低客户端 ║
║    版本时，用户将无法使用任何功能          ║
║                                            ║
║  • 谨慎修改：修改"最低客户端版本"将影响所有║
║    用户，建议提前通知                      ║
║                                            ║
║  • 回滚方法：如需取消强制更新，将"最低客户端║
║    版本"改回较低版本即可                   ║
╚═══════════════════════════════════════════╝
```

### 配置预览区域

```
╔═══════════════════════════════════════════╗
║ 👁️ 当前配置预览                [刷新]     ║
╠═════════════════════╤═══════════════════════╣
║ 服务器版本号        │ [1.0.0]              ║
├─────────────────────┼───────────────────────┤
║ 最低客户端版本      │ [1.0.0]              ║
├─────────────────────┴───────────────────────┤
║ 更新提示消息                               ║
║ 发现新版本，请立即更新客户端               ║
├─────────────────────────────────────────────┤
║ 版本比较结果                               ║
║ ✓ 配置正常                                 ║
╚═════════════════════════════════════════════╝
```

---

## 技术特性

### 1. 实时验证

**版本号格式验证**:
```javascript
const versionRegex = /^\d+\.\d+\.\d+$/;
if (!versionRegex.test(server_version)) {
    ElMessage.error('版本号格式不正确');
    return;
}
```

**版本逻辑验证**:
```javascript
if (min_client_version > server_version) {
    // 显示警告对话框
    await ElMessageBox.confirm('版本配置警告...');
}
```

### 2. 友好提示

- ✅ **输入提示**: 每个字段下方都有说明文字
- ✅ **格式说明**: Info 类型的提示框
- ✅ **重要警告**: Warning 类型的提示框
- ✅ **操作反馈**: 成功/失败的 Message 提示
- ✅ **二次确认**: 危险操作前的确认对话框

### 3. 用户体验

- ✅ **保存中状态**: 按钮显示 loading
- ✅ **自动刷新**: 保存成功后自动刷新预览
- ✅ **版本对比**: 实时显示版本比较结果
- ✅ **颜色标识**: Success/Warning/Info 标签区分
- ✅ **响应式布局**: 适配不同屏幕尺寸

---

## API 权限说明

### 权限验证

所有系统设置 API 都需要管理员权限：

```python
username: str = Depends(verify_admin)
```

### 验证流程

1. 检查 Cookie 中的 `admin_session`
2. 验证 Session Token 是否有效
3. 验证是否为管理员用户
4. 权限验证失败返回 401 未授权

---

## 错误处理

### 客户端错误

**1. 版本号格式错误**
```
❌ 服务器版本号格式不正确，应为 x.y.z 格式（例如: 1.0.0）
```

**2. 版本逻辑警告**
```
⚠️ 最低客户端版本高于服务器版本，这可能导致混乱。确定要保存吗？
```

### 服务器错误

**1. 格式验证失败 (400)**
```json
{
  "detail": "服务器版本号格式不正确"
}
```

**2. 未授权访问 (401)**
```json
{
  "detail": "未授权访问"
}
```

**3. 服务器内部错误 (500)**
```json
{
  "detail": "内部服务器错误"
}
```

---

## 数据库操作

### 配置读取

```python
server_version = db.query(Config).filter(Config.key == "server_version").first()
```

### 配置更新

```python
config = db.query(Config).filter(Config.key == key).first()
if config:
    config.value = value
    config.updated_at = datetime.utcnow()
else:
    config = Config(key=key, value=value, description=desc)
    db.add(config)
db.commit()
```

---

## 测试建议

### 功能测试

1. ✅ 加载默认配置
2. ✅ 修改版本号并保存
3. ✅ 版本号格式验证
4. ✅ 版本逻辑警告
5. ✅ 刷新配置
6. ✅ 客户端版本检查生效

### 安全测试

1. ✅ 未登录访问（应返回 401）
2. ✅ 普通用户访问（应拒绝）
3. ✅ 管理员访问（应成功）
4. ✅ Session 过期处理

### UI 测试

1. ✅ 表单输入验证
2. ✅ 按钮 loading 状态
3. ✅ 错误提示显示
4. ✅ 成功提示显示
5. ✅ 配置预览更新

---

## 部署说明

### 更新步骤

```bash
# 1. 停止容器
docker-compose down

# 2. 重新构建并启动
docker-compose up -d --build

# 3. 检查日志
docker-compose logs -f app

# 4. 访问系统设置页面
# http://your-domain/admin/settings
```

### 验证部署

1. 登录管理后台
2. 点击左侧"系统设置"菜单
3. 检查页面是否正常显示
4. 尝试修改并保存配置
5. 检查客户端版本检查是否生效

---

## 总结

**新增功能**:
- ✅ 系统设置导航菜单
- ✅ 版本控制可视化配置页面
- ✅ 获取版本配置 API
- ✅ 更新版本配置 API
- ✅ 实时版本验证
- ✅ 版本比较和警告
- ✅ 友好的帮助文档

**优势**:
- 🎯 **无需 SQL**: 管理员通过界面直接操作
- 🛡️ **安全可靠**: 格式验证 + 权限验证
- 💡 **友好易用**: 详细说明 + 实时反馈
- 🎨 **美观现代**: Element Plus 组件库
- ⚡ **即时生效**: 保存后立即对客户端生效

现在管理员可以轻松管理版本控制，无需手动操作数据库！🎉
